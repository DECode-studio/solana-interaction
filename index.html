<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solana Phantom Wallet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .btn {
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
    }

    .btn-primary {
      background: #4CAF50;
      color: #fff;
      border: none;
    }

    .btn-secondary {
      background: #2196F3;
      color: #fff;
      border: none;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-disconnected {
      background: red;
    }

    .status-connected {
      background: green;
    }

    #messageInput {
      width: 300px;
      padding: 8px;
    }

    #result {
      margin-top: 15px;
      white-space: pre-wrap;
    }
  </style>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>

<body>
  <h2>Phantom Wallet Connection</h2>

  <!-- Connect Wallet -->
  <button id="connectButton" class="btn btn-primary">
    <span id="statusIndicator" class="status-indicator status-disconnected"></span>
    <span id="statusText">Connect Phantom Wallet</span>
  </button>

  <!-- Address -->
  <div id="walletAddress"></div>

  <!-- Transaction -->
  <button id="sendTransactionButton" class="btn btn-secondary">Send Transaction</button>

  <!-- Sign Message -->
  <div>
    <input type="text" id="messageInput" placeholder="Enter message" />
    <button id="signMessageButton" class="btn btn-secondary">Sign Message</button>
  </div>

  <!-- Result -->
  <pre id="result"></pre>

  <script>
    const { Connection, PublicKey, clusterApiUrl, Transaction, SystemProgram } = solanaWeb3;

    let provider = null;
    let connection = null;
    let publicKey = null;

    const connectButton = document.getElementById('connectButton');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const walletAddressDiv = document.getElementById('walletAddress');
    const sendTransactionButton = document.getElementById('sendTransactionButton');
    const signMessageButton = document.getElementById('signMessageButton');
    const resultPre = document.getElementById('result');
    const messageInput = document.getElementById('messageInput');

    // Ganti cluster ke "devnet" kalau mau test
    const CLUSTER = "devnet";
    connection = new Connection(clusterApiUrl(CLUSTER), 'confirmed');

    function updateConnectionStatus(connected) {
      statusIndicator.className = connected
        ? 'status-indicator status-connected'
        : 'status-indicator status-disconnected';
      statusText.textContent = connected ? 'Wallet Connected' : 'Connect Phantom Wallet';
    }

    async function connectWallet() {
      try {
        provider = window.solana;
        if (!provider?.isPhantom) {
          alert("Phantom Wallet not found! Please install it.");
          return;
        }
        const resp = await provider.connect();
        publicKey = resp.publicKey;
        walletAddressDiv.innerText = `Connected: ${publicKey.toString()}`;
        updateConnectionStatus(true);
      } catch (err) {
        console.error("Connection failed", err);
        resultPre.textContent = "Connection failed: " + err.message;
      }
    }

    async function sendTransaction() {
      try {
        if (!publicKey) throw new Error("Wallet not connected");
        const recipient = new PublicKey("EnterValidRecipientPublicKeyHere"); // ganti dengan pubkey tujuan

        const instruction = SystemProgram.transfer({
          fromPubkey: publicKey,
          toPubkey: recipient,
          lamports: 1000, // 0.000001 SOL
        });

        const tx = new Transaction().add(instruction);
        tx.feePayer = publicKey;

        const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;

        const { signature } = await provider.signAndSendTransaction(tx);
        resultPre.textContent = "Transaction sent! Signature: " + signature;

        // Confirm transaction
        await connection.confirmTransaction({
          signature,
          blockhash,
          lastValidBlockHeight
        }, 'confirmed');

        const explorerUrl = `https://explorer.solana.com/tx/${signature}?cluster=${CLUSTER}`;
        resultPre.textContent += `\nView on Explorer: ${explorerUrl}`;
      } catch (err) {
        console.error("Transaction failed", err);
        resultPre.textContent = "Transaction failed: " + err.message;
      }
    }

    async function signMessage() {
      try {
        if (!publicKey) throw new Error("Wallet not connected");
        const messageText = messageInput.value || "Hello from Solana!";
        const message = new TextEncoder().encode(messageText);

        const { signature } = await provider.signMessage(message);
        resultPre.textContent = "Message signed successfully!\nSignature: " + btoa(String.fromCharCode(...signature));
      } catch (err) {
        console.error("Sign message failed", err);
        resultPre.textContent = "Sign message failed: " + err.message;
      }
    }

    // Event listeners
    connectButton.addEventListener('click', connectWallet);
    sendTransactionButton.addEventListener('click', sendTransaction);
    signMessageButton.addEventListener('click', signMessage);

    // Auto-detect connection
    if (window.solana?.isConnected) {
      publicKey = window.solana.publicKey;
      walletAddressDiv.innerText = `Connected: ${publicKey.toString()}`;
      updateConnectionStatus(true);
    }
  </script>
</body>

</html>